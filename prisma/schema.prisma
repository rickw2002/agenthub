// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum OrgRole {
  OWNER
  MEMBER
  VIEWER
}

enum DocumentScope {
  GLOBAL
  PROJECT
}

enum DocumentStatus {
  uploaded
  processing
  ready
  failed
}

model User {
  id            String           @id @default(cuid())
  email         String           @unique
  name          String
  passwordHash  String
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  userAgents    UserAgent[]
  connections   Connection[]
  metricDailies MetricDaily[]
  insights      Insight[]
  chatMessages  ChatMessage[]
  workspaces    Workspace[]
  memberships   Membership[]
}

model AgentTemplate {
  id              String      @id @default(cuid())
  name            String
  slug            String      @unique
  category        String      // bijv. "Sales", "Marketing", "Operations"
  shortDescription String
  longDescription String
  type            String      // "agent" of "workflow"
  difficulty      String      // bijv. "beginner", "advanced"
  videoUrl        String?     // optioneel
  configSchema    String      // JSON veld met configuratie schema
  executor        String      @default("n8n") // "n8n" of andere executor
  n8nWorkflowId   String?     // n8n workflow ID
  n8nWebhookPath  String?     // n8n webhook path
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  userAgents      UserAgent[]
}

model UserAgent {
  id              String      @id @default(cuid())
  userId          String
  agentTemplateId String
  name            String      // door de user gekozen naam
  config          String      // JSON met ingevulde instellingen
  status          String      // "active", "inactive", "incomplete"
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  agentTemplate   AgentTemplate @relation(fields: [agentTemplateId], references: [id], onDelete: Cascade)
  runLogs         RunLog[]
}

model RunLog {
  id            String     @id @default(cuid())
  userAgentId  String
  status        String     // "queued" | "running" | "success" | "failed"
  summary       String?
  resultUrl     String?
  error         String?
  metadata      String?    // JSON as string
  executor      String     @default("n8n") // "n8n" of andere executor
  externalRunId String?    // n8n execution ID of andere external ID
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  userAgent     UserAgent  @relation(fields: [userAgentId], references: [id], onDelete: Cascade)
}

// Data Hub Models
// Note: We store enum/JSON-like values as String for broad provider compatibility
// Provider values: GOOGLE_ADS, META_ADS, LINKEDIN, WEBSITE, EMAIL, SUPPORT
// ConnectionStatus values: CONNECTED, PENDING, ERROR, NOT_CONNECTED
// InsightSeverity values: INFO, WARNING, CRITICAL
// ChatScope values: MASTER, GOOGLE_ADS, META_ADS, LINKEDIN, WEBSITE, EMAIL, SUPPORT
// ChatRole values: USER, ASSISTANT

model Connection {
  id        String   @id @default(cuid())
  userId    String
  provider  String   // GOOGLE_ADS | META_ADS | LINKEDIN | WEBSITE | EMAIL | SUPPORT
  status    String   // CONNECTED | PENDING | ERROR | NOT_CONNECTED
  authJson  String?  // JSON stored as string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([userId, provider])
}

model MetricDaily {
  id             String   @id @default(cuid())
  userId         String
  provider       String   // GOOGLE_ADS | META_ADS | LINKEDIN | WEBSITE | EMAIL | SUPPORT
  date           DateTime
  metricsJson    String   // JSON stored as string
  dimensionsJson String?  // JSON stored as string
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, provider])
  @@index([userId, provider, date])
}

model Insight {
  id          String   @id @default(cuid())
  userId      String
  provider    String?  // GOOGLE_ADS | META_ADS | LINKEDIN | WEBSITE | EMAIL | SUPPORT | null for master
  title       String
  summary     String
  severity    String   // INFO | WARNING | CRITICAL
  period      String?
  dataRefJson String?  // JSON stored as string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, provider])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  scope     String   // MASTER | GOOGLE_ADS | META_ADS | LINKEDIN | WEBSITE | EMAIL | SUPPORT
  role      String   // USER | ASSISTANT
  content   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, scope])
}

model Workspace {
  id             String            @id @default(cuid())
  name           String
  ownerId       String
  organizationId String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  owner         User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  organization  Organization?     @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  context       WorkspaceContext?
  documents     Document[]
  chunks        DocumentChunk[]
  profileAnswers ProfileAnswer[]
  profileStates  ProfileState[]
  profileCards   ProfileCard[]
  examples       Example[]
  outputs        Output[]

  @@index([ownerId])
  @@index([organizationId])
}

model WorkspaceContext {
  id              String    @id @default(cuid())
  workspaceId     String    @unique
  profileJson     String    // JSON stored as string
  goalsJson       String    // JSON stored as string
  preferencesJson String    // JSON stored as string
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Document {
  id             String        @id @default(cuid())
  workspaceId    String
  organizationId String?
  scope          DocumentScope @default(PROJECT)
  projectId      String?
  title          String
  fileUrl        String
  status         DocumentStatus @default(uploaded)
  error          String?
  createdAt      DateTime      @default(now())
  workspace      Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  chunks         DocumentChunk[]

  @@index([workspaceId])
  @@index([organizationId])
  @@index([projectId])
  @@index([scope])
}

model DocumentChunk {
  id             String        @id @default(cuid())
  documentId     String
  workspaceId    String
  organizationId String?
  scope          DocumentScope @default(PROJECT)
  projectId      String?
  chunkIndex     Int
  text           String
  embedding      String?      // placeholder voor pgvector embedding
  createdAt      DateTime      @default(now())
  document       Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  workspace      Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([documentId])
  @@index([organizationId])
  @@index([projectId])
  @@index([scope])
  @@unique([documentId, chunkIndex])
}

model Organization {
  id          String       @id @default(cuid())
  name        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  memberships Membership[]
  workspaces  Workspace[]
  projects    Project[]
  documents   Document[]
  chunks      DocumentChunk[]
  prompts     Prompt[]
}

model Membership {
  id             String        @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole       @default(OWNER)
  createdAt      DateTime      @default(now())

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

model Project {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?
  isArchived     Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  settings       ProjectSettings?
  chats          ProjectChat[]
  documents      Document[]
  chunks         DocumentChunk[]
  profileAnswers ProfileAnswer[]
  profileStates  ProfileState[]
  profileCards   ProfileCard[]
  examples       Example[]
  outputs        Output[]

  @@index([organizationId])
}

model ProjectSettings {
  id               String   @id @default(cuid())
  projectId        String   @unique
  useGlobalLibrary Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectChat {
  id        String   @id @default(cuid())
  projectId String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages  ProjectChatMessage[]

  @@index([projectId])
}

model ProjectChatMessage {
  id            String   @id @default(cuid())
  projectChatId String
  role          String
  content       String
  sourcesJson   String?
  metaJson      String?
  createdAt     DateTime @default(now())

  chat          ProjectChat @relation(fields: [projectChatId], references: [id], onDelete: Cascade)

  @@index([projectChatId])
}

model Prompt {
  id             String   @id @default(cuid())
  organizationId String
  title          String
  body           String
  tags           String   // Comma-separated tags
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

enum ExampleKind {
  good
  bad
}

enum OutputChannel {
  linkedin
  blog
}

enum OutputMode {
  thought_to_post
  brainstorm
  batch_qa
  content_bank
}

model ProfileAnswer {
  id          String   @id @default(cuid())
  workspaceId String
  projectId   String?
  questionKey String
  answerText  String
  answerJson  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, projectId, questionKey])
  @@index([workspaceId])
  @@index([projectId])
}

model ProfileState {
  id               String   @id @default(cuid())
  workspaceId      String
  projectId        String?
  knownKeys        Json?
  missingKeys      Json?
  confidenceScore  Float    @default(0)
  lastQuestionKey  String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, projectId])
  @@index([workspaceId])
  @@index([projectId])
}

model ProfileCard {
  id            String   @id @default(cuid())
  workspaceId   String
  projectId     String?
  version       Int
  voiceCard     Json
  audienceCard  Json
  offerCard     Json
  constraints   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, projectId, version])
  @@index([workspaceId])
  @@index([projectId])
}

model Example {
  id          String     @id @default(cuid())
  workspaceId String
  projectId   String?
  kind        ExampleKind
  content     String
  notes       String?
  createdAt   DateTime   @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([projectId])
  @@index([workspaceId, kind])
}

model Output {
  id                 String        @id @default(cuid())
  workspaceId        String
  projectId          String?
  channel            OutputChannel
  mode               OutputMode
  inputJson          Json
  content            String
  quality            Json?
  tokensUsed         Int?
  costEstimate       Float?
  promptVersion      String?
  modelName          String?
  specVersion        String?
  profileCardVersion Int?
  rewriteCount       Int?
  failReason         String?
  createdAt          DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  feedbacks Feedback[]

  @@index([workspaceId])
  @@index([projectId])
  @@index([workspaceId, channel, mode, createdAt])
}

model Feedback {
  id        String   @id @default(cuid())
  outputId  String
  rating    Int
  notes     String?
  createdAt DateTime @default(now())

  output Output @relation(fields: [outputId], references: [id], onDelete: Cascade)

  @@index([outputId])
}

